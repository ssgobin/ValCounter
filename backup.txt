import os
import json
from twitchio.ext import commands
import firebase_admin
from firebase_admin import credentials, firestore
import asyncio

# Inicializa o Firebase
cred = credentials.Certificate(r'C:\Users\ssgobin\Desktop\TUDO\ValoCounter.v0.1\serviceAccountKey.json')
firebase_admin.initialize_app(cred)
db = firestore.client()

# Lista de administradores (adicione os nomes dos administradores aqui)
ADMINS = ['admin_user1', 'admin_user2']  # Substitua pelos nomes de usuários reais

# Inicializa o bot
class Bot(commands.Bot):

    def __init__(self):
        self.initial_channels = []  # Lista de canais iniciais
        super().__init__(token='gno2xk9rdd28u8io39tydoci6eaftj', prefix='val!')

    async def event_ready(self):
        print(f'Bot conectado como {self.nick}')
        self.initial_channels = await self.ler_canais_iniciais()  # Lê os canais iniciais
        print(f'Canais iniciais carregados: {self.initial_channels}')  # Log para mostrar os canais carregados
        await self.add_channels()  # Adiciona os canais ao bot
        asyncio.create_task(self.monitor_channels())  # Inicia monitoramento dos canais

    async def monitor_channels(self):
        while True:
            await asyncio.sleep(10)  # Espera 10 segundos antes de verificar novamente
            new_channels = await self.ler_canais_iniciais()  # Verifica os canais novamente
            if sorted(new_channels) != sorted(self.initial_channels):
                print("Atualizando canais...")
                self.initial_channels = new_channels  # Atualiza a lista de canais
                await self.add_channels()  # Adiciona os novos canais ao bot

    async def add_channels(self):
        await self.join_channels(self.initial_channels)  # Adiciona os canais ao bot
        print(f'Canais ativos: {self.initial_channels}')  # Log dos canais ativos

    async def ler_canais_iniciais(self):
        # Lê os canais do Firestore
        try:
            channels_ref = db.collection('channels').stream()
            channels = [channel.id for channel in channels_ref]  # Coleta os IDs dos documentos como nomes dos canais
            return channels
        except Exception as e:
            print(f"Erro ao ler canais do Firestore: {e}")
            return []

    async def event_message(self, message):
        # Verifica se o autor da mensagem existe e se não é o próprio bot
        if message.author is None or message.author.name.lower() == self.nick.lower():
            return

        await self.handle_commands(message)

    async def checar_admin(self, user):
        return user.lower() in [admin.lower() for admin in ADMINS]

    @commands.command(name='vitoria')
    async def ganhar(self, ctx):
        if await self.checar_admin(ctx.author.name):
            user = ctx.author.name
            await self.atualizar_contagem(user, 'vitorias')
            await ctx.send(f'{user} ganhou uma partida!')
        else:
            await ctx.send("Desculpe, você não tem permissão para usar esse comando.")

    @commands.command(name='derrota')
    async def perder(self, ctx):
        if await self.checar_admin(ctx.author.name):
            user = ctx.author.name
            await self.atualizar_contagem(user, 'derrotas')
            await ctx.send(f'{user} perdeu uma partida!')
        else:
            await ctx.send("Desculpe, você não tem permissão para usar esse comando.")

    async def atualizar_contagem(self, user, tipo):
        # Atualiza a contagem no Firestore
        doc_ref = db.collection('streamers').document(user)

        try:
            doc = doc_ref.get()
            
            if doc.exists:
                data = doc.to_dict()
                if tipo == 'vitorias':
                    data['vitorias'] += 1
                else:
                    data['derrotas'] += 1
                doc_ref.update(data)
                print(f"Contagem de {tipo} atualizada para {user}.")  # Log de sucesso
            else:
                # Caso o streamer não esteja registrado, adiciona um novo
                await self.adicionar_streamer(user)
                await self.atualizar_contagem(user, tipo)  # Tenta atualizar a contagem novamente
        except Exception as e:
            print(f"Erro ao atualizar contagem para {user}: {e}")  # Log de erro

    async def adicionar_streamer(self, user):
        # Adiciona um novo streamer ao Firestore
        doc_ref = db.collection('streamers').document(user)

        try:
            doc = doc_ref.get()

            if not doc.exists:
                print(f"Streamer {user} não encontrado, adicionando ao Firestore...")  # Log de depuração
                doc_ref.set({
                    'vitorias': 0,
                    'derrotas': 0,
                })
                print(f"Streamer {user} registrado com sucesso.")  # Log de sucesso
            else:
                print(f"Streamer {user} já está registrado.")  # Log de depuração
        except Exception as e:
            print(f"Erro ao adicionar streamer {user}: {e}")  # Log de erro

if __name__ == '__main__':
    bot = Bot()
    bot.run()
